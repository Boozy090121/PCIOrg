<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Quality Org Hub - Focus Factory: BBV, ADD & ARB. A comprehensive quality management system." />
  
  <title>Quality Re-Org & Capability Management Tool</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Main stylesheet -->
  <link rel="stylesheet" href="src/css/tailwind.css" />
  <link rel="stylesheet" href="src/css/team-styles.css" />
  <link rel="stylesheet" href="src/css/skilltree.css" />
  <link rel="stylesheet" href="src/css/planning.css" />
  <link rel="stylesheet" href="src/css/shared-resources.css" />
  <link rel="stylesheet" href="src/css/firebase-ui.css" />
  <link rel="stylesheet" href="src/css/styles.css" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  
  <!-- Base styles for fallback and recovery screens -->
  <style>
    /* Root CSS variables for theming */
    :root {
      --primary-color: #00518A; /* Default to BBV color */
      --text-color: #212529;
      --bg-color: #ffffff;
      --bg-light: #f8f9fa;
      --border-color: #dee2e6;
      --bbv-color: #00518A;
      --add-color: #CC2030;
      --arb-color: #4F46E5;
      --shared-color: #232323;
    }

    /* Value stream specific themes */
    [data-value-stream="bbv"] {
      --primary-color: var(--bbv-color);
    }
    [data-value-stream="add"] {
      --primary-color: var(--add-color);
    }
    [data-value-stream="arb"] {
      --primary-color: var(--arb-color);
    }

    /* General styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-color);
      background-color: var(--bg-light);
      margin: 0;
      padding: 0;
    }

    /* Essential styles that don't depend on external files */
    .initial-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 80%;
      width: 400px;
    }
    .error-content {
      text-align: center;
    }
    .error-message {
      margin: 15px 0;
      color: #dc3545;
    }
    /* Global layout */
    .app-container {
      display: flex;
      height: 100vh;
      position: relative;
      z-index: 1; /* Lower z-index than loader */
      visibility: visible; /* Explicitly set visibility */
    }
    /* When loader is active, hide the app container content visually but maintain layout */
    body.loading .app-container {
      visibility: hidden;
      pointer-events: none; /* Prevent clicks when loading */
    }
    .sidebar {
      width: 250px;
      background-color: var(--bg-light);
      border-right: 1px solid var(--border-color);
      height: 100%;
      overflow-y: auto;
    }
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    /* Sidebar navigation styles */
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--bg-light);
    }
    .sidebar-header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
    }
    .value-stream-selector {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--bg-light);
    }
    .value-stream-selector label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 0.9rem;
      color: #495057;
    }
    
    /* Focus factory buttons */
    .focus-factory-buttons {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    
    .factory-btn {
      flex: 1;
      padding: 8px 5px;
      text-align: center;
      border: 1px solid var(--border-color);
      background-color: var(--bg-light);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .factory-btn:hover {
      background-color: #e9ecef;
    }
    
    .factory-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    /* Factory button specific colors */
    #factory-bbv.active {
      background-color: var(--bbv-color);
      border-color: var(--bbv-color);
    }
    
    #factory-add.active {
      background-color: var(--add-color);
      border-color: var(--add-color);
    }
    
    #factory-arb.active {
      background-color: var(--arb-color);
      border-color: var(--arb-color);
    }
    
    .sidebar-nav {
      padding: 15px 0;
    }
    
    /* Navigation item styles */
    .nav-item {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border: none;
      background: none;
      font-size: 0.95rem;
      color: #495057;
      cursor: pointer;
      transition: background-color 0.2s;
      text-decoration: none;
      border-left: 3px solid transparent;
      margin-bottom: 2px;
    }
    
    .nav-item:hover {
      background-color: #e9ecef;
    }
    
    .nav-item.active {
      background-color: #e9ecef;
      color: var(--primary-color);
      font-weight: 500;
      border-left: 3px solid var(--primary-color);
    }
    
    .nav-item i {
      width: 20px;
      margin-right: 8px;
      text-align: center;
    }
    
    .nav-button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border: none;
      background: none;
      font-size: 0.95rem;
      color: #495057;
      cursor: pointer;
      transition: background-color 0.2s;
      text-decoration: none;
    }
    
    /* Context header styles */
    .context-header {
      padding: 15px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    .context-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
    }
    
    /* Tab content styles */
    .tab-content {
      background-color: var(--bg-color);
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 20px;
    }

    /* Dashboard styles */
    .dashboard-container {
      margin-bottom: 20px;
    }
    .dashboard-header {
      margin-bottom: 15px;
    }
    .dashboard-header h2 {
      color: var(--primary-color);
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .dashboard-card {
      background-color: var(--bg-color);
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 15px;
    }
    .dashboard-card h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
      color: var(--primary-color);
    }
    .chart-container {
      height: 250px;
      position: relative;
    }

    /* Team and value stream colors */
    .bbv {
      color: var(--bbv-color);
    }
    .add {
      color: var(--add-color);
    }
    .arb {
      color: var(--arb-color);
    }
    .bg-bbv {
      background-color: var(--bbv-color);
      color: white;
    }
    .bg-add {
      background-color: var(--add-color);
      color: white;
    }
    .bg-arb {
      background-color: var(--arb-color);
      color: white;
    }
    .border-bbv {
      border-color: var(--bbv-color);
    }
    .border-add {
      border-color: var(--add-color);
    }
    .border-arb {
      border-color: var(--arb-color);
    }
    
    /* Chart styles */
    canvas {
      max-width: 100%;
      height: auto !important;
    }
    
    /* Team card styles */
    .team-card {
      border-radius: 5px;
      border-top: 4px solid;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      background-color: var(--bg-color);
    }
    .team-card.bbv {
      border-top-color: var(--bbv-color);
    }
    .team-card.add {
      border-top-color: var(--add-color);
    }
    .team-card.arb {
      border-top-color: var(--arb-color);
    }
    .team-card-header {
      padding: 15px;
      border-bottom: 1px solid #e9ecef;
    }
    .team-card-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    .team-card-body {
      padding: 15px;
    }
    
    /* Stream badge */
    .stream-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .stream-badge.bbv {
      background-color: var(--bbv-color);
      color: white;
    }
    .stream-badge.add {
      background-color: var(--add-color);
      color: white;
    }
    .stream-badge.arb {
      background-color: var(--arb-color);
      color: white;
    }

    /* Value stream specific body styles */
    body.stream-bbv .stream-highlight {
      color: var(--bbv-color);
    }
    body.stream-add .stream-highlight {
      color: var(--add-color);
    }
    body.stream-arb .stream-highlight {
      color: var(--arb-color);
    }

    /* Important bug fix styles */
    .sidebar-nav .nav-item {
      display: flex !important;
      visibility: visible !important;
      align-items: center !important;
      width: 100% !important;
      padding: 10px 15px !important;
      margin-bottom: 2px !important;
      text-align: left !important;
      border-left: 3px solid transparent !important;
      background: none !important;
      font-size: 0.95rem !important;
      color: #495057 !important;
      cursor: pointer !important;
      transition: background-color 0.2s !important;
      text-decoration: none !important;
      opacity: 1 !important;
    }

    .sidebar-nav .nav-item:hover {
      background-color: #e9ecef !important;
    }

    .sidebar-nav .nav-item.active {
      background-color: #e9ecef !important;
      color: var(--primary-color) !important;
      font-weight: 500 !important;
      border-left: 3px solid var(--primary-color) !important;
    }

    .sidebar-nav .nav-item i {
      width: 20px !important;
      margin-right: 8px !important;
      text-align: center !important;
      display: inline-block !important;
    }
    
    /* Ensure the sidebar is visible */
    .sidebar {
      display: block !important;
      visibility: visible !important;
    }
    
    /* Ensure the sidebar navigation container is visible */
    .sidebar-nav {
      display: block !important;
      visibility: visible !important;
      padding: 15px 0 !important;
    }

    /* Modal styles */
    .modal {
      display: none !important; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    /* Only display modals when they have an 'active' class */
    .modal.active {
      display: block !important;
      opacity: 1;
    }
    
    /* Modal content */
    .modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      max-width: 600px;
      width: 90%;
      position: relative;
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    /* Close button */
    .close-modal, .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    
    .close-modal:hover, .modal-close:hover {
      color: #000;
    }
    
    /* Modal header */
    .modal-header {
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .modal-header h3 {
      margin: 0;
      padding-right: 30px;
    }
    
    /* Modal footer */
    .modal-footer {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 15px;
      text-align: right;
    }
    
    /* Form modals should be hidden by default */
    .form-modal {
      display: none !important;
    }
    
    /* Only display form modals when explicitly shown */
    .form-modal.active {
      display: block !important;
    }

    /* Firebase related styles */
    .firebase-status {
      padding: 5px 10px;
      margin: 5px 0;
      font-size: 0.8rem;
      border-radius: 4px;
      display: none;
    }
    .firebase-status.connected {
      background-color: #d4edda;
      color: #155724;
      display: block;
    }
    .firebase-status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
      display: block;
    }
    .firebase-status.syncing {
      background-color: #fff3cd;
      color: #856404;
      display: block;
    }
  </style>
  
  <!-- Safety timeout to force hide loader -->
  <script>
    // Add loading class to body initially
    document.body.classList.add('loading');
    document.documentElement.setAttribute('data-value-stream', 'bbv'); // Default to BBV
    
    // Force hide loader after 8 seconds no matter what
    setTimeout(function() {
      var loader = document.getElementById('initialLoader');
      if (loader && loader.style.display !== 'none') {
        console.warn('Safety timeout: Forcing loader to hide');
        loader.style.display = 'none';
        
        // Remove loading class from body
        document.body.classList.remove('loading');
        
        // Show minimal emergency UI if needed
        var emergencyDiv = document.createElement('div');
        emergencyDiv.style.padding = '20px';
        emergencyDiv.style.backgroundColor = '#f8f9fa';
        emergencyDiv.style.border = '1px solid #dee2e6';
        emergencyDiv.style.borderRadius = '4px';
        emergencyDiv.style.margin = '20px';
        
        emergencyDiv.innerHTML = `
          <h3 style="color: #dc3545; margin-bottom: 10px;">Loading timeout occurred</h3>
          <p>The application is taking longer than expected to load.</p>
          <p>You can:</p>
          <button onclick="window.location.reload()" style="background-color: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Reload the page</button>
          <button onclick="window.location.reload(true)" style="background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 10px 0 0 10px;">Force reload (clear cache)</button>
        `;
        
        document.body.appendChild(emergencyDiv);
      }
    }, 8000);
    
    // Initialize basic objects to prevent recovery mode
    window.app = window.app || {};
    window.data = window.data || {};
    window.config = window.config || {
      colors: {
        bbv: '#00518A',
        add: '#CC2030',
        arb: '#4F46E5'
      }
    };
    window.ui = window.ui || {};
    
    // Add debugging listeners
    window.addEventListener('DOMContentLoaded', () => {
      console.log('DOM content loaded');
    });
    
    // Global error handler
    window.addEventListener('error', function(event) {
      console.error('Global error:', event.error);
      const errorDetails = document.getElementById('errorDetails');
      if (errorDetails) {
        errorDetails.textContent = event.error.message || 'Unknown error';
        errorDetails.style.display = 'block';
      }
    });
  </script>
</head>
<body class="loading stream-bbv">
  <!-- Hide all modals on page load -->
  <script>
    // Ensure all modals are hidden on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Hide any modals that might be showing
      document.querySelectorAll('.modal').forEach(function(modal) {
        modal.classList.remove('active');
      });
    });
  </script>
  
  <!-- Loading screen -->
  <div id="initialLoader" class="initial-loader">
    <div class="loader-spinner"></div>
    <p>Loading Quality Re-Org & Capability Management Tool...</p>
    <p id="loadingStatus" style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">Initializing...</p>
    <div id="errorDetails" style="color: red; margin-top: 10px; display: none;"></div>
  </div>

  <!-- Error dialog -->
  <div class="error-dialog" style="display: none;">
    <div class="error-content">
      <h3>Error</h3>
      <p class="error-message"></p>
      <button onclick="this.parentElement.parentElement.style.display='none'">Close</button>
    </div>
  </div>

  <!-- Main app structure -->
  <div class="app-container">
    <!-- Sidebar navigation -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1>Quality Re-Org Tool</h1>
        <!-- Firebase status indicator -->
        <div id="firebase-status" class="firebase-status">
          <i class="fas fa-circle"></i> <span class="status-text">Initializing...</span>
        </div>
      </div>
      
      <!-- Value stream selector -->
      <div class="value-stream-selector">
        <label for="value-stream">Focus Factory:</label>
        <div class="focus-factory-buttons">
          <button id="factory-bbv" class="factory-btn active" data-value="bbv">BBV</button>
          <button id="factory-add" class="factory-btn" data-value="add">ADD</button>
          <button id="factory-arb" class="factory-btn" data-value="arb">ARB</button>
        </div>
      </div>

      <!-- Navigation tabs -->
      <div class="sidebar-nav"></div>
    </nav>

    <!-- Main content area -->
    <main class="main-content">
      <!-- Context header -->
      <header class="context-header">
        <h2 id="context-title">Dashboard</h2>
      </header>

      <!-- Tab content -->
      <div id="tabContent" class="tab-content"></div>
    </main>
  </div>

  <!-- Inline mock data for use without a server -->
  <script>
    // Mock data for teams
    window.mockData = {
      teams: [
        {
          id: 1,
          name: 'BBV Quality Team',
          stream: 'bbv',
          description: 'Quality team supporting BBV product line',
          responsibilities: 'Manage quality assurance processes, perform audits, handle documentation',
          performance: 75,
          personnel: [
            { id: 1, name: 'John Smith', role: 'Quality Account Manager', client: 'Client 1' },
            { id: 2, name: 'Jane Doe', role: 'Quality Engineer', client: 'Client 1' },
            { id: 3, name: 'Michael Brown', role: 'Quality Coordinator', client: 'Client 2' }
          ]
        },
        {
          id: 2,
          name: 'ADD Quality Team',
          stream: 'add',
          description: 'Quality team supporting ADD product line',
          responsibilities: 'Handle documentation, support audits, manage CAPAs',
          performance: 82,
          personnel: [
            { id: 4, name: 'Sarah Johnson', role: 'Quality Account Manager', client: 'Client 3' },
            { id: 5, name: 'Robert Williams', role: 'Document Control Specialist', client: 'Client 3' }
          ]
        },
        {
          id: 3,
          name: 'ARB Quality Team',
          stream: 'arb',
          description: 'Quality team supporting ARB product line',
          responsibilities: 'Quality oversight, compliance management, audit support',
          performance: 90,
          personnel: [
            { id: 6, name: 'Emily Davis', role: 'Quality Lead', client: 'Client 4' },
            { id: 7, name: 'James Wilson', role: 'Quality Specialist', client: 'Client 5' }
          ]
        }
      ],
      personnel: [
        { id: 1, name: 'John Smith', role: 'Quality Account Manager', stream: 'bbv', skills: ['Quality Systems', 'Auditing', 'Documentation'] },
        { id: 2, name: 'Jane Doe', role: 'Quality Engineer', stream: 'bbv', skills: ['Process Validation', 'Root Cause Analysis', 'CAPA'] },
        { id: 3, name: 'Michael Brown', role: 'Quality Coordinator', stream: 'bbv', skills: ['Documentation', 'Change Control', 'Training'] },
        { id: 4, name: 'Sarah Johnson', role: 'Quality Account Manager', stream: 'add', skills: ['Quality Systems', 'Regulatory Compliance', 'Risk Assessment'] },
        { id: 5, name: 'Robert Williams', role: 'Document Control Specialist', stream: 'add', skills: ['Document Management', 'SOP Writing', 'Training'] },
        { id: 6, name: 'Emily Davis', role: 'Quality Lead', stream: 'arb', skills: ['Quality Oversight', 'Audit Management', 'Regulatory Affairs'] },
        { id: 7, name: 'James Wilson', role: 'Quality Specialist', stream: 'arb', skills: ['GMP Compliance', 'Deviation Management', 'Quality Risk Management'] },
        { id: 8, name: 'Lisa Thompson', role: 'Quality Engineer', stream: 'shared', skills: ['Validation', 'Equipment Qualification', 'Computer System Validation'] }
      ]
    };
    
    // Add mock API endpoint functions
    window.api = {
      getTeams: function() {
        return Promise.resolve({ teams: window.mockData.teams });
      },
      getPersonnel: function() {
        return Promise.resolve({ personnel: window.mockData.personnel });
      }
    };
  </script>

  <!-- Loading status updater -->
  <script>
    // Update loading status periodically
    let loadingStep = 0;
    const loadingSteps = [
      'Initializing...',
      'Loading components...',
      'Preparing UI...',
      'Fetching data...'
    ];
    
    const updateLoadingStatus = () => {
      const statusElement = document.getElementById('loadingStatus');
      if (statusElement) {
        statusElement.textContent = loadingSteps[loadingStep % loadingSteps.length];
        loadingStep++;
      }
    };
    
    // Update loading status every 800ms
    const loadingInterval = setInterval(updateLoadingStatus, 800);
    
    // Stop updating after 8 seconds (failsafe)
    setTimeout(() => {
      clearInterval(loadingInterval);
    }, 8000);
    
    // Stop when page is loaded
    window.addEventListener('load', () => {
      clearInterval(loadingInterval);
    });
    
    // Helper function to load scripts
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Failed to load ${src}`));
        document.body.appendChild(script);
        
        // Set a timeout for script loading to prevent hanging
        const timeout = setTimeout(() => {
          reject(new Error(`Timeout loading ${src}`));
        }, 5000);
        
        // Clear timeout on success
        script.onload = () => {
          clearTimeout(timeout);
          resolve();
        };
      });
    }
  </script>

  <!-- Core JS files -->
  <script src="js/main.js"></script>
  <script src="js/core/config.js"></script>
  <script src="js/core/dataService.js"></script>
  <script src="js/core/data.js"></script>
  <script src="js/core/app.js"></script>
  
  <!-- Module JS files -->
  <script src="js/modules/ui.js"></script>
  <script src="js/modules/orgchart.js"></script>
  <script src="js/modules/racimatrix.js"></script>
  
  <!-- Main initialization -->
  <script>
    // Initialize the application when all scripts are loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Check if all required scripts are loaded
      const requiredObjects = ['config', 'ui', 'orgChart', 'raciMatrix'];
      const missingObjects = requiredObjects.filter(obj => !window[obj]);
      
      if (missingObjects.length > 0) {
        console.error(`Missing required objects: ${missingObjects.join(', ')}`);
        
        // Show error in loader
        const errorDetails = document.getElementById('errorDetails');
        if (errorDetails) {
          errorDetails.textContent = `Failed to load required modules: ${missingObjects.join(', ')}`;
          errorDetails.style.display = 'block';
        }
        
        return;
      }
      
      // Initialize UI
      if (window.ui && typeof window.ui.init === 'function') {
        window.ui.init().then(() => {
          console.log('Application initialized successfully');
          
          // Hide the loader
          const loader = document.getElementById('initialLoader');
          if (loader) {
            loader.style.display = 'none';
          }
          
          // Remove loading class from body
          document.body.classList.remove('loading');
        }).catch(error => {
          console.error('Failed to initialize UI:', error);
          
          // Show error in loader
          const errorDetails = document.getElementById('errorDetails');
          if (errorDetails) {
            errorDetails.textContent = `Failed to initialize UI: ${error.message}`;
            errorDetails.style.display = 'block';
          }
        });
      } else {
        console.error('UI module not found or init method not available');
        
        // Show error in loader
        const errorDetails = document.getElementById('errorDetails');
        if (errorDetails) {
          errorDetails.textContent = 'UI module not found or init method not available';
          errorDetails.style.display = 'block';
        }
      }
    });
  </script>

  <!-- Add a null check for classList references around line 354 -->
  <script>
    function initTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      if (!tabBtns || tabBtns.length === 0) return;
      
      // Set initial tab based on URL hash or localStorage
      let activeTab = window.location.hash.substring(1) || localStorage.getItem('activeTab') || 'dashboard';
      
      // Ensure the tab exists, fallback to dashboard if not
      const tabExists = Array.from(tabBtns).some(btn => btn.getAttribute('data-tab') === activeTab);
      if (!tabExists) {
        activeTab = 'dashboard';
      }
      
      // Activate the tab
      tabBtns.forEach(btn => {
        const tabId = btn.getAttribute('data-tab');
        const tabContent = document.getElementById(tabId);
        
        // Add null checks for both the button and tab content
        if (btn && btn.classList && tabContent) {
          if (tabId === activeTab) {
            btn.classList.add('active');
            tabContent.classList.add('active');
          } else {
            btn.classList.remove('active');
            tabContent.classList.remove('active');
          }
        }
        
        // Add click event
        btn.addEventListener('click', function() {
          const clickedTabId = this.getAttribute('data-tab');
          
          // Update active classes with null checks
          tabBtns.forEach(b => {
            if (b && b.classList) {
              b.classList.remove('active');
            }
          });
          
          if (this && this.classList) {
            this.classList.add('active');
          }
          
          // Update tab content visibility with null checks
          document.querySelectorAll('.tab-content').forEach(content => {
            if (content && content.classList) {
              content.classList.remove('active');
            }
          });
          
          const activeContent = document.getElementById(clickedTabId);
          if (activeContent && activeContent.classList) {
            activeContent.classList.add('active');
          }
          
          // Save active tab to localStorage and update URL hash
          localStorage.setItem('activeTab', clickedTabId);
          window.location.hash = clickedTabId;
        });
      });
    }
  </script>

  <!-- Emergency script to fix navigation visibility issues -->
  <script>
    // Force fix for navigation visibility after everything else has loaded
    window.addEventListener('load', function() {
      // Ensure navigation items are visible
      setTimeout(function() {
        const navItems = document.querySelectorAll('.nav-item');
        if (navItems.length === 0) {
          console.error('Navigation items not found, attempting to recreate them');
          
          // Try to recreate the navigation if it's missing
          if (window.ui && typeof window.ui.setupTabs === 'function') {
            window.ui.setupTabs();
          }
          
          // If we still don't have nav items, create them manually
          if (document.querySelectorAll('.nav-item').length === 0) {
            const sidebarNav = document.querySelector('.sidebar-nav');
            if (sidebarNav) {
              const tabs = [
                { id: 'dashboard', icon: 'fa-tachometer-alt', title: 'Dashboard' },
                { id: 'personnel', icon: 'fa-users', title: 'Personnel' },
                { id: 'teamBuilder', icon: 'fa-user-friends', title: 'Team Builder' },
                { id: 'clientFactory', icon: 'fa-building', title: 'Clients & Factories' },
                { id: 'sharedResources', icon: 'fa-people-arrows', title: 'Shared Resources' },
                { id: 'racimatrix', icon: 'fa-table', title: 'RACI Matrix' },
                { id: 'skillsmatrix', icon: 'fa-chart-bar', title: 'Skills Matrix' },
                { id: 'gapanalysis', icon: 'fa-search', title: 'Gap Analysis' },
                { id: 'planning', icon: 'fa-calendar-alt', title: 'Planning' },
                { id: 'analytics', icon: 'fa-chart-line', title: 'Analytics' }
              ];
              
              const tabsHtml = tabs.map(tab => `
                <a href="#" class="nav-item" data-tab="${tab.id}">
                  <i class="fas ${tab.icon}"></i>
                  <span>${tab.title}</span>
                </a>
              `).join('');
              
              sidebarNav.innerHTML = tabsHtml;
              
              // Add click events to the manually created tabs
              document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                  e.preventDefault();
                  const tabId = this.getAttribute('data-tab');
                  if (window.ui && typeof window.ui.switchTab === 'function') {
                    window.ui.switchTab(tabId);
                  }
                });
              });
              
              console.log('Navigation items created manually');
            }
          }
        }
        
        // Ensure focus factory buttons work
        const factoryButtons = document.querySelectorAll('.factory-btn');
        factoryButtons.forEach(btn => {
          btn.addEventListener('click', function() {
            // Remove active class from all buttons
            factoryButtons.forEach(b => b.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get the value stream and update app state
            const valueStream = this.getAttribute('data-value');
            if (window.appData && window.appData.state) {
              window.appData.state.valueStream = valueStream;
            }
            
            // Update styling
            document.documentElement.setAttribute('data-value-stream', valueStream);
            document.body.className = document.body.className.replace(/stream-\w+/g, '');
            document.body.classList.add(`stream-${valueStream}`);
            
            // Refresh the current tab if ui is available
            if (window.ui && typeof window.ui.switchTab === 'function' && window.appData) {
              const currentTab = window.appData.state.currentTab || 'dashboard';
              window.ui.switchTab(currentTab);
            }
          });
        });
        
      }, 1000); // Give the app a second to initialize properly
    });
  </script>

  <!-- Firebase UI component -->
  <template id="firebase-ui-template">
    <div class="firebase-ui-container">
      <div class="firebase-controls">
        <h4>Data Storage Controls</h4>
        <div class="button-group">
          <button id="btn-sync-to-firebase" class="btn btn-primary">
            <i class="fas fa-cloud-upload-alt"></i> Sync to Cloud
          </button>
          <button id="btn-load-from-firebase" class="btn btn-secondary">
            <i class="fas fa-cloud-download-alt"></i> Load from Cloud
          </button>
          <button id="btn-reset-firebase" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i> Reset Cloud Data
          </button>
        </div>
        <div class="sync-status"></div>
      </div>
    </div>
  </template>
</body>
</html>

