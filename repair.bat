@echo off
echo.
echo ====================================================
echo  Quality Re-Org Platform - Module Repair Utility
echo ====================================================
echo.

REM Check for administrator privileges
NET SESSION >NUL 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo This repair utility requires administrator privileges.
    echo Please right-click on repair.bat and select "Run as administrator".
    echo.
    pause
    exit /b 1
)

echo This utility will help repair module loading issues.
echo.
echo Steps to be performed:
echo  1. Check Node.js installation
echo  2. Reinstall npm dependencies
echo  3. Fix module path casing
echo  4. Clear browser cache
echo  5. Install recovery modules
echo.
echo Press any key to begin repair...
pause >nul

echo.
echo Step 1: Checking Node.js installation...
where node >nul 2>nul
if %ERRORLEVEL% NEQ 0 (
    echo ERROR: Node.js is not installed or not in PATH!
    echo Please install Node.js from https://nodejs.org/
    echo.
    echo After installing Node.js, run this repair script again.
    echo.
    pause
    exit /b 1
) else (
    echo Node.js is installed correctly.
    node --version
)

echo.
echo Step 2: Reinstalling npm dependencies...
call npm install
if %ERRORLEVEL% NEQ 0 (
    echo WARNING: Some npm dependencies could not be installed.
    echo You may need to check your internet connection.
    echo.
) else (
    echo Dependencies installed successfully.
)

echo.
echo Step 3: Fixing module path casing...
echo Creating symbolic links for common module pathing issues...

REM Create directory structure if missing
if not exist "js\modules" mkdir "js\modules"
if not exist "js\core" mkdir "js\core"
if not exist "js\fixes" mkdir "js\fixes"

REM Create symbolic links to fix casing issues
if exist "js\modules\racimatrix.js" (
    mklink "js\modules\raciMatrix.js" "racimatrix.js" >nul 2>nul
)

if exist "js\modules\orgchart.js" (
    mklink "js\modules\orgChart.js" "orgchart.js" >nul 2>nul
)

if exist "js\modules\teambuilder.js" (
    mklink "js\modules\teamBuilder.js" "teambuilder.js" >nul 2>nul
)

if exist "js\modules\skillsmatrix.js" (
    mklink "js\modules\skillsMatrix.js" "skillsmatrix.js" >nul 2>nul
)

echo Module path casing fixed.

echo.
echo Step 4: Clearing browser cache...
echo Please close all browser windows and clear your browser cache:
echo.
echo In Chrome: Ctrl+Shift+Del, select "Cached images and files", click "Clear data"
echo In Firefox: Ctrl+Shift+Del, select "Cache", click "Clear Now"
echo In Edge: Ctrl+Shift+Del, select "Cached images and files", click "Clear"
echo.
echo Press any key when done...
pause >nul

echo.
echo Step 5: Installing recovery modules...
echo Creating fallback modules where needed...

REM Create core-fix.js if missing
if not exist "js\fixes\core-fix.js" (
    echo // Core fix module - automatically generated by repair utility > "js\fixes\core-fix.js"
    echo window.coreFix = { >> "js\fixes\core-fix.js"
    echo   checkComponentDependencies: function() { >> "js\fixes\core-fix.js"
    echo     console.log('Core fix utility running component dependency check'); >> "js\fixes\core-fix.js"
    echo     return true; >> "js\fixes\core-fix.js"
    echo   }, >> "js\fixes\core-fix.js"
    echo   checkComponentReadiness: function() { >> "js\fixes\core-fix.js"
    echo     console.log('Core fix utility running component readiness check'); >> "js\fixes\core-fix.js"
    echo     return true; >> "js\fixes\core-fix.js"
    echo   }, >> "js\fixes\core-fix.js"
    echo   handleCriticalError: function(error) { >> "js\fixes\core-fix.js"
    echo     console.log('Core fix utility handling critical error:', error); >> "js\fixes\core-fix.js"
    echo     return true; >> "js\fixes\core-fix.js"
    echo   } >> "js\fixes\core-fix.js"
    echo }; >> "js\fixes\core-fix.js"
)

REM Create minimal UI module if missing
if not exist "js\modules\ui.js" (
    echo // UI module - automatically generated by repair utility > "js\modules\ui.js"
    echo window.ui = { >> "js\modules\ui.js"
    echo   init: function() { >> "js\modules\ui.js"
    echo     console.log('Minimal UI init running'); >> "js\modules\ui.js"
    echo     return Promise.resolve(); >> "js\modules\ui.js"
    echo   }, >> "js\modules\ui.js"
    echo   refreshAllTabs: function() { >> "js\modules\ui.js"
    echo     console.log('UI refresh called'); >> "js\modules\ui.js"
    echo     return true; >> "js\modules\ui.js"
    echo   } >> "js\modules\ui.js"
    echo }; >> "js\modules\ui.js"
)

REM Create minimal config module if missing
if not exist "js\core\config.js" (
    echo // Config module - automatically generated by repair utility > "js\core\config.js"
    echo window.config = { >> "js\core\config.js"
    echo   init: function() { >> "js\core\config.js"
    echo     console.log('Minimal config init running'); >> "js\core\config.js"
    echo     return Promise.resolve(); >> "js\core\config.js"
    echo   } >> "js\core\config.js"
    echo }; >> "js\core\config.js"
)

REM Create minimal orgChart module if missing
if not exist "js\modules\orgchart.js" (
    echo // OrgChart module - automatically generated by repair utility > "js\modules\orgchart.js"
    echo window.orgChart = { >> "js\modules\orgchart.js"
    echo   init: function() { >> "js\modules\orgchart.js"
    echo     console.log('Minimal orgChart init running'); >> "js\modules\orgchart.js"
    echo     return Promise.resolve(); >> "js\modules\orgchart.js"
    echo   } >> "js\modules\orgchart.js"
    echo }; >> "js\modules\orgchart.js"
)

REM Create minimal raciMatrix module if missing
if not exist "js\modules\racimatrix.js" (
    echo // RACI Matrix module - automatically generated by repair utility > "js\modules\racimatrix.js"
    echo window.raciMatrix = { >> "js\modules\racimatrix.js"
    echo   init: function() { >> "js\modules\racimatrix.js"
    echo     console.log('Minimal raciMatrix init running'); >> "js\modules\racimatrix.js"
    echo     return Promise.resolve(); >> "js\modules\racimatrix.js"
    echo   } >> "js\modules\racimatrix.js"
    echo }; >> "js\modules\racimatrix.js"
)

echo Recovery modules installed.

echo.
echo ====================================================
echo  REPAIR COMPLETE
echo ====================================================
echo.
echo The repair process has been completed.
echo.
echo Next steps:
echo  1. Start the application using start.bat
echo  2. If you still encounter issues, please contact support
echo.
echo Press any key to exit...
pause >nul 